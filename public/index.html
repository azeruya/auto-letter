<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Letter Generator</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 820px; margin: 40px auto; }
    form { display: grid; gap: 8px; }
    input, textarea { padding: 8px; font-size: 14px; width: 100%; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { padding: 10px 14px; cursor: pointer; }
    fieldset { border: 1px solid #ddd; padding: 12px; }
    legend { padding: 0 6px; }
  </style>
</head>
<body>
  <h1>Auto Letter Generator</h1>

  <fieldset>
    <legend>Form Mode</legend>
    <form id="form-mode">
      <div class="row">
        <input name="refNo" placeholder="Ref No (No. Rujukan)" />
        <input name="date" placeholder="Date (YYYY-MM-DD / Tanggal)" value="">
      </div>
      <input name="recipientName" placeholder="Recipient Name (Nama Penerima)" />
      <input name="recipientAddress" placeholder="Recipient Address (Alamat Penerima)" />
      <input name="subject" placeholder="Subject (Perihal)" />
      <textarea name="content" rows="6" placeholder="Content (Isi Surat)"></textarea>
      <div class="row">
        <input name="senderName" placeholder="Sender Name (Nama Pengirim)" />
        <input name="senderPosition" placeholder="Position (Jabatan)" />
      </div>
      <input name="organization" placeholder="Organization (Instansi)" />
      <button type="submit">Generate .docx</button>
    </form>
  </fieldset>

  <br />

  <fieldset>
    <legend>Upload Template Mode</legend>
    <form id="upload-mode">
      <input type="file" name="template" accept=".docx" required />
      <textarea name="data" rows="6" placeholder='JSON data matching your placeholders, e.g. {"recipientName":"Bapak/Ibu"}'></textarea>
      <button type="submit">Upload & Generate</button>
      <small>Tip: Use /api/inspect-template to discover placeholders.</small>
    </form>
  </fieldset>

  <script>
    // helper: trigger browser download from a Blob
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("form-mode").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      // default date today if left blank
      if (!payload.date) payload.date = new Date().toISOString().slice(0,10);
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) return alert("Error: " + (await res.text()));
      const blob = await res.blob();
      downloadBlob(blob, "Official_Letter.docx");
    });

    document.getElementById("upload-mode").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      // If "data" textarea is empty, at least send an empty JSON object
      if (!fd.get("data")) fd.set("data", "{}");
      const res = await fetch("/api/upload-and-generate", {
        method: "POST",
        body: fd,
      });
      if (!res.ok) return alert("Error: " + (await res.text()));
      const blob = await res.blob();
      downloadBlob(blob, "Generated_From_Template.docx");
    });
  </script>
</body>
</html>
